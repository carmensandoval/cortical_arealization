---
title: "Constellation Plots: Neocortex, 2nd Trimester" 
subtitle: "All Samples, All cell types"
output: html_notebook
---
```{r}
setwd("~/constellation_plots/R/")

source("../../../code_general/setup_R_session_CSE.R")
attach(.env)

```

# LOAD DATA.
# _________________________________________________________________________________________________

• Neocortex_v3.RData
Not necessary if just plotting on already calculated PCA, UMAP, clusters.
```{r}
# load("2ndTrimester/constellation_plots/data/cfc4b2_neocortex_v3.RData")

# 40k random subset (toy dataset)
ncx.40k <- read_rds("constellation_plots/ncx_v3_40k.rds")
```

• Cluster / marker tables.
```{r paged.print=TRUE}
ncx.clusters <- read_delim("../tbls/83d19_Neocortex_allindividuals_combinedclusters_v1.txt",
                              "\t", escape_double = FALSE, trim_ws = TRUE)

ncx.markers <- read_delim("../tbls/8f0fc_Neocortex_subset1_clustermarkers_combo2.txt", 
                  "\t", escape_double = FALSE, trim_ws = TRUE)
```

• Smaller dataset for working locally / not on massive cluster:
```{r}
# Custom function subsetSeurat (described below in fxns section)
subsetSeurat(Neocortex, "data/ncx_v3_40k.rds")

# On Mac
ncx.small <- read_rds("~/tmp/constellation_plots/c7104_ncx_v3_4k.rds")

# Reductions exported from neocortex_v3 [cfc4b2_neocortex_v3.RData] object:
# This is the only part that's really needed for the plots.
ncx.reductions <- read_rds("~/tmp/constellation_plots/11163_neocortex_v3_reductions.rds")
```

# START `scrattch.hicat` method.
# ______________________________________________________________________________

## 1. Define which cells to build the plot from.
  [All cells: 404.2K]
  
a. All clusters / cell types:
Keep only cells with *_combo2_* `$combined.cluster.2` annotation.
```{r}
cells.cl.df <- ncx.clusters %>% filter(str_detect(combined.cluster.2, "combo2"))
# 348K cells
```

b. Excitatory neuron lineage only:
Keep only cells with *_combo2_* `$combined.cluster.2` annotation AND
whose `$combined.cluster.2` annotation belongs to excitatory neuronal lineage classes.
```{r}
cells.cl.df <-  ncx.clusters %>% 
                  filter(str_detect(combined.cluster.2, "combo2") ) %>% 
                        filter(str_detect(combined.cluster.2, "Neuron|CR|Dividing|RG|IPC|OPC") ) %>%
                            filter( cell.name %in% rownames(ncx.40k@meta.data) )
# 271.3K cells

cells.cl.df
```

```{r}
ncx.27k <- subsetSeurat(ncx.40k, cells.keep = cells.cl.df$cell.name)
```

## 2. Build dataframes for constellation plots.

### 1. `cl` 
```{r}
cl <- cells.cl.df$combined.cluster.2 %>% as.factor %>% 
        set_names(cells.cl.df$cell.name)
# 128 clusters for all _combo2_ cells
# 77 clusters for all _combo2_ & exc. neuronal lineage.
```

#### 2. `rd.dat`
```{r}
s.obj <- ncx.27k

rd.dat <- list(umap = s.obj@reductions$umap@cell.embeddings,
               pca = s.obj@reductions$pca@cell.embeddings)

# Subset UMAP and PCA cell embeddings: keep only cells in ncx.clusters.
# (Exclude cells in cluster 0 and keep only cells with "combo2" in combined cluster 2 name.)
rd.dat %<>% lapply(function(x) x[names(cl), ])
```

#### 3. `cl.df`
```{r}
cl.df <- get_cl_df(cl)
cl.df$clade <- str_split_fixed(cl.df$cluster_label, "_", 2)[ ,1] %>% tolower 

# Add clade_id, clade_color to cl.df
clade.cols <- data.frame(# clade = unique(cl.df$clade),
                        cluster_color = c("cr"= "darkgrey", 
                                  "dividing" = "darkkhaki", 
                                  "neuron" = "deepskyblue", 
                                  "inteneuron" = "deeppink2", 
                                  "ipc" = "brown4", 
                                  "microglia" = "darkorchid1",
                                  "opc" = "cadetblue", 
                                  "other" = "darkslateblue", 
                                  "rg" = "darkorange", 
                                  "vascular" = "blanchedalmond")
            ) %>% rownames_to_column("clade")

cl.df %<>% left_join(clade.cols)
```

#### 4. `rd.cl.center` Find cluster centers from UMAP coordinates
```{r}
rd.cl.center <- get_RD_cl_center(rd.dat$umap, cl) 

rd.cl.center %<>% 
  as.data.frame %>% 
  set_names(c("x", "y")) %>%
  add_column(cl = 1:nrow(rd.cl.center), .before = "x") %>%
  # add_column preserves rownames.
  # but moving rownames to column cluster_label anyway bc of left_join below.
  rownames_to_column("cluster_label")
```

#### 5. `cl.center.df`
Join `cl.df` and `rd.cl.center` into `cl.center.df` for input into `get_KNN_graph`.
```{r}
cl.center.df <- left_join(rd.cl.center, cl.df,
                           by = c("cluster_label")) 
```

#### 6. `knn.cl` 
```{r}
# Fixes needed for proper output of knn.cl.df
# cl.center.df %<>% rename(cluster_size = "size")
# levels(cl) <- cl.df$cluster_id
cl.numeric <- cl
levels(cl.numeric) <- cl.df$cluster_id

# knn.result <- RANN::nn2(data = rd.dat$pca[ , 1:10], k = 15)

knn.cl <- get_knn_graph(rd.dat = rd.dat$pca[ , 1:10], 
                        cl.df =  cl.df, cl = cl.numeric, 
                        k = 15, 
                        knn.outlier.th = 2, outlier.frac.t = 0.5)

```

### 2. Make constellation plot
```{r}
# Keep only cells where $frac [fraction of cells in cluster with nearest neighbors in different cluster] >= 0.05.
# Defined in `get_knn_graph`: 
# knn.cl.df$frac = knn.cl.df$Freq / knn.cl.df$cl.from.total
# 10% : 213 edges
knn.cl.df <- knn.cl$knn.cl.df %>% filter(frac >= 0.1)

# Plot only edges between ExN lineage clusters.
# knn.cl.df %<>% filter_at(vars(cl.from.label, cl.to.label), 
#                        all_vars(str_detect(., "RG|IPC|Neuron|OPC|Dividing"))
#              )

cl.center.df$cluster_label %<>% str_remove("_combo2")
  
cl.plot <- plot_constellation(knn.cl.df, cl.center.df, out.dir = ".", 
                                node.label = "cluster_label", exxageration = 1, curved = TRUE, 
                                plot.parts = FALSE, plot.hull = NULL, plot.height = 40, plot.width = 25, 
                                node.dodge = TRUE, label.size = 2, max_size = 15)


```
# ______________________________________________________________________________
# Find differences between clusters
```{r}
nn.cl.df <- knn.cl$pred.result$pred.prob %>% as.data.frame
left_join(nn.cl.df, cells.cl.df, by = c("query" = "cell.name")) 

left_join(test, cl.df, by = c("combined.cluster.2" = "cluster_label"))
```




## Seurat
### FindNeighbors
https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html
> We first construct a K-nearest neighbors graph based on the euclidean distance in PCA space.
  Refine the edge weights between any two cells based on the shared overlap in their local
  neighborhoods (Jaccard similarity). 
  This step is performed using the FindNeighbors function, and takes as input the previously defined
  dimensionality of the dataset (first 10 PCs).

```{r not-run}
FindNeighbors.default <- function(
  object,
  distance.matrix = FALSE,
  k.param = 20,
  compute.SNN = TRUE,
  prune.SNN = 1/15,
  nn.method = 'rann',
  annoy.metric = "euclidean",
  nn.eps = 0,
  verbose = TRUE,
  force.recalc = FALSE,
  ...
)
```

```{r}
ncx.small %<>% FindNeighbors(verbose = TRUE, do.plot = FALSE)
```

```{r}
ncx.small@graphs %>% lapply(corner)
```


## Other functions
```{r}
# Custom function to downsample object.
subsetSeurat <- function(object = NULL, fraction = NULL, cells.keep = NULL, write.to = "path/to/filename.rds") {
  
                    if( is.numeric(fraction) ) { # Random subset of x% of all cells.
                       if(cells.keep == NULL) {
                        print("Subsetting to random subset of cells.")
                        cells.keep <- object@meta.data %>% rownames %>% sample(size = length(.)*fraction)
                       } else 
                         print("Either a fraction OR a vector of cells must be provided.")
                      
                    } else if( length(cells.keep) > 0) {
                        print("Using specified cells to create subset of Seurat object.")
                      
                    } else(print("Either a fraction OR a vector of cells must be provided."))
                    
                    obj.small <- object %>% subset(cells = cells.keep)
                    
                    if( ! write.to == "path/to/filename.rds" ) {
                      print("Writing file.")
                       write_rds(obj.small, write.to)
                    }
                     
                    return(obj.small)
              }
                        

```

```{r}
sessionInfo()
```
## References
Install ggforce on cluster:
https://stackoverflow.com/a/59231055/4463919


