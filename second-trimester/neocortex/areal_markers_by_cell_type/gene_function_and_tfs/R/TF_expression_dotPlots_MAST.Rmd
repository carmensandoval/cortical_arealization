---
title: "TF expression dot plots with MAST genes"
date: 2020-11-30
output: html_document
---

# DotPlots: TF expression
across areas and stages

```{r}
p_load(Seurat)
load('transcription_factor_composition_workspace.RData')

source('./funcs/make_TFDotPlots.R')
ncx_full <- read_rds(file.path(data.dir, 'exn_lineage/neocortex_exn_seuratobj.rds'))
tfs <- read_rds('../out/TFs_MAST_wilcox_p0.1.rds')
```


# Combine Wilcox and MAST genes and keep genes that are TFs.
```{r}
markers <- read_rds('../../general/markers_MAST_wilcox_p0.1.rds')
tfs_db %<>% select(gene = 'hgnc_symbol', family)

# Start with p < 0.1 markers.
markers$markers_ab %<>% rename(enrichment.ratio = 'gene.ratio')
markers %<>% set_names(c('wilcox', 'MAST'))
tfs <- markers %>% map(~ left_join(.x, tfs_db) %>% dplyr::filter(! is.na(family)))
                       
# Combine both tables of marker TFs into a single one with a source column.
tfs$MAST_wilcox <- imap(tfs, ~ .x %>% mutate(source = .y)) %>% reduce(bind_rows)

tfs$MAST_wilcox %<>% 
  unite(group, cell_type, area, stage, remove = FALSE) %>% 
  arrange(cell_type, area, stage, gene) %>% 
  select(gene, group, individual, gene.score, enrichment.ratio, pct.1, pct.2, avg_logfc,
         everything())

# Synthesize genes into a single vector.
tfs$MAST_wilcox_by_group <- tfs$MAST_wilcox %>% group_by(cell_type, area, stage) %>% 
                              summarise(genes = list(unique(as.character(gene)))) %>%
                                unite(group, cell_type, area, stage, remove = FALSE)

tfs %>% write_rds('../out/TFs_MAST_wilcox_p0.1.rds')
# [2020-11-29] Start from here to make dotplots.
```

# - - - - - - - - - - -
```{r}
# markers_plot_MAST <- markers_MAST %>% dplyr::filter(p_val_adj <= 0.1 & is_tf == 'TF')
# markers_plot_wilcox <- markers_ab %>% dplyr::filter(p_val_adj <= 0.1 & is_tf == 'TF')
markers_plot <- tfs_by_group_MAST_wilcox

gene_list <- markers_plot %>% filter(cell_type == 'rg', 
                                     area == 'pfc', stage == 'early')

seurat_object <- ncx_full %>% subset(subset = (cell_type == 'rg' & 
                                                 stage == 'early'))

dotplot <- makeDotPlot(seurat_object = seurat_object, 
                       cell_type = 'rg', area = 'pfc', 
                       genes_list = gene_list$genes, scale = TRUE)

# Fix axis order ffs
dotplot[[1]]$data %<>% 
  separate(id, into = c('cell_type', 'id')) %>% 
  mutate(features.plot = as.factor(as.character(features.plot)),
         id = factor(id, levels = levels(ncx_full@meta.data$area))
  )
```

# My own dot plot
Using Seurat's DotPlot calculation for average expression per group.
```{r}
# 2020-12-02
dotplots <- list()
indivs_by_stage <- ncx_full@meta.data %>% count(stage, individual)

# Make plots
dotplots <- groups_plot %>%

          pmap(function(...) {
            
            # Make main plot 
                ncx_full <- SetIdent(ncx_full, value = 'celltype_stage')
                 
                 message('\n GROUP: ', group <- ..1, '\n')
                 cell_type <- ..2
                 area <- ..3
                 my_stage <- ..4
                 genes_plot <- ..5
                 
                 
                 (celltype_stage = paste(cell_type, my_stage, sep = "_"))
                 
                 dotplot <- makeDotPlot(seurat_object = ncx_full, 
                                        group = ..1,
                                        idents_use = celltype_stage,
                                        area = ..3, 
                                        genes_list = ..5,
                                        split_by = 'area',
                                        group_by = 'cell_type',
                                        scale = FALSE)
      
            # Make individual plots ----------------------------------------------------------------
              message('// Make individual dot plots //')
           
              message('Stage: ')
              print(paste(area, my_stage, sep = "_"))
              
              message('Individuals: \n')
              # print(indivs_by_stage %>% dplyr::filter(stage == my_stage))
              print(individuals <- indivs_by_stage %>% dplyr::filter(stage == my_stage) %>% 
                      pull(individual) %>% as.character)
              
              message('Set new idents')
              Idents(ncx_full) <- ncx_full@meta.data %>% str_glue_data('{cell_type}_{individual}')
           
              dotplots_indiv <- map(individuals, .f = function(x) {
                                    message('Individual:')
                                    print(x)
                                    # function(individual = .x) {
                                   message('ident_use:')
                                   print(celltype_indiv <- paste(cell_type, x, sep = "_"))
           
                                   makeDotPlot(seurat_object = ncx_full, 
                                               group = group,
                                               idents_use = celltype_indiv, 
                                               area = area, 
                                               genes_list = genes_plot,
                                               split_by = 'area',
                                               group_by = 'individual',
                                               scale = FALSE)
                                })
                          
                         dotplots_indiv %<>% 
                           lapply(function(x) 
                                  x + ggtitle('') + theme(legend.position = 'none')
                                  )
            # \END Make individual plots -----------------------------------------------------------
                                   
          dotplots <- lst(dotplot, dotplots_indiv)
           
          #  p_indiv <- wrap_plots(dotplots_indiv) 
          #  patchwork <- (dotplot/p_indiv) + plot_layout(nrow = 2)
          #  
          #  
          #  ggsave(plot = patchwork, filename = paste0('../out/plots/dotplot_', group, '.pdf'), device = 'pdf',
          #         width = 20, height = 15)
          #  
          })

names(dotplots) <- groups_plot$group
dotplots %>% map(printDotPlots)
sms('DotPlots')

groups_plot <- tfs$MAST_wilcox_by_group %>% 
                dplyr::filter((group %>% str_detect('rg') & group %>% str_detect('early'))
                              # (group %>% str_detect('neuron') & group %>% str_detect('mid'))
                              ) 


# [x] TODO [2020-12-07] RG early: temporal and V1 need to be adjusted.
# [x] TODO [2020-12-07] gw19_2: no neurons in ncx_full
```

# Print main plot + individual plots in a single page

## 3-individual panels (early + mid)
```{r}
printDotPlots <- function(x, n_rows_indiv = 1, n_areas = 6) {
  
    n_genes <- x$dotplot$data[ ,'features.plot'] %>% n_distinct()
    width_main <- n_genes / 3
    
    if(width_main < 5) { width_main <- 5 }
       else{ width_main }

    n_individuals <- x$dotplots_indiv %>% length
    # 
    # if(n_individuals > 3) {
    #   n_rows_indiv <- ceiling(n_individuals / 3)
    # } else{ n_rows_indiv <- 1 }
    # 
    # if(n_genes > 20) { n_rows_indiv <- n_rows_indiv + 1}
  
 
    # top_main <- wrap_plots(x$dotplot, plot_spacer(), plot_spacer())
    bottom_indiv <- wrap_plots(x$dotplots_indiv, nrow = n_individuals)
    
    # n_rows_panel <- n_rows_indiv + 1
    
    panel <- wrap_plots(x$dotplot, bottom_indiv, 
                        nrow = 2,
                        heights = c( (1/n_individuals) * .75, 1), 
                        guides = 'keep')
    
    # my_width <- width_main * n_individuals
    my_width <- width_main
    my_height <- (n_areas/3) * (n_individuals + 2)
    # aspect_ratio = width / height
    
    title <- x$dotplot$labels$title
    
    message(paste0(
            title, '\n',
            'n_individuals = ', n_individuals, '\n',
            'n_rows_indiv = ', n_rows_indiv, '\n',
            'n_genes = ', n_genes, '\n',
            'width = ', my_width, '\n',
            'height = ', my_height, '\n')
    )
    
    ggsave(plot = panel, filename = paste0('../out/plots/tf_dotplots/', title, '.pdf'),
           width = my_width, height = my_height, units = 'in', limitsize = FALSE)
}

```

# Add gw19_2 neurons to ncx_full
```{r 2020-12-07}
load('../../../data/gw19_2.RData')

annot_gw19_2 <- read_tsv(file.path(data.dir, 'tbls/gw19_2_clusteridentity_wholebrain_annotated.txt'))
annot_gw19_2 %<>% mutate(area = cell_name %>% 
                                  str_replace('gw19_2_([:alnum:]+)_[:alpha:]+', '\\1') %>%
                                    str_replace('ss|SS', 'somatosensory'),
                         across(.cols = c(cell_type, area), tolower),
                         structure = str_replace(area, areas.rgx, 'neocortex'),
                         cell_type = str_replace(cell_type, 'excitatory neuron', 'neuron'))

annot_gw19_2_ncx <- annot_gw19_2 %>% dplyr::filter(structure == 'neocortex')

gw19_2 <- UpdateSeuratObject(gw19_2)


gw19_2@meta.data %<>% rownames_to_column('cell_name') %>% 
                        set_names(tolower(names(.))) %>% 
                          mutate(individual = 'gw19_2') %>% 
                            left_join(annot_gw19_2_ncx %>% select(cell_name, cell_type)) %>%
                              select(cell_name, structure, area, cell_type, everything()) %>%
                                # select(-structure.1, -area.1) %>%

                                  mutate(across(.cols = c(structure, area, cell_type), tolower)) %>%
                                    set_rownames(.$cell_name)
  


gw19_2_ncx_neuron <- subset(gw19_2, subset = (structure == 'neocortex' & cell_type == 'neuron'))

ncx_full <- merge(x = ncx_full, gw19_2_ncx_neuron)
# Some cell names are duplicated across objects provided. Renaming to enforce unique cell names.
# WTF
dfilter <- dplyr::filter

ncx_full@meta.data %>% dfilter(individual == 'gw19_2' & cell_type == 'neuron') %>% count(celltype_stage)
# 1 neocortex        cr    63
# 2 neocortex  dividing  2499
# 3 neocortex       ipc  2763
# 4 neocortex    neuron 16380
# 5 neocortex       opc   807
# 6 neocortex        rg  2496

ncx_full@meta.data %<>% select(ngene:region)
ncx_full@meta.data %<>% expandMetadata()
```

dotplots <- list(dotplot = dotplots[[1]]$dotplot, dotplots_indiv = dotplots[[1]]$dotplots_indiv[1:3])

names(dotplots$dotplots_indiv) <- c('p1', 'p2', 'p3')

dotplots[[1]] %>% wrap_plots(layout = A##, BC)
                             
3 plots in early panels (1 main + 3 indiv)
3 plots in mid panels (1 main + 3 indiv)
7 plots in early panels (1 main + 7 indiv)

# Default figure width = 7in, height = 5in}


```
2020-12-03
Check why ncx_full doesn't have neurons.
```{r}
ncx_exn <- read_rds(file.path(data.dir, 'exn_lineage/neocortex_exn_lineage_271k.rds'))
sms('ncx_exn read')

ncx_exn@meta.data %>% dplyr::filter(cell.name %>% str_detect('gw19_2')) %>% count(cell.type)
# ncx_exn gw19_2 does not have neurons.

ncx <- load('cfc4b2_neocortex_v3.RData')

ncx_exn@meta.data[1:10, ] %>% str_split(.$cell.name) count(cell_type)
```


My own dotplots - moved this to `make_TFDotPlots.R`
```{r}
# Scale average expression values by individual.
x <- dotplot[[1]]$data %>% 
  separate(id, c('individual', 'area'), remove = FALSE) %>% 
  group_by(features.plot, individual) %>%
  mutate(scaled_exp = scale(avg.exp, center = TRUE)) %>%
  ungroup


x %<>% mutate(area = factor(area, levels = levels(ncx_full@meta.data$area))) %>%
  arrange(individual, area) %>% 
  mutate(id = as_factor(as.character(id)),
         features.plot = as.factor(as.character(features.plot)))
         
dotplot <- ggplot(x) + ggtitle(paste(cell_type, area, stage))
  
  geom_point(aes(x = features.plot, y = id, 
                           color = scaled_exp, size = pct.exp)) +
  scale_colour_gradientn(colours = rev(heatmap.colors),
                       # TODO Maybe keep high yellow, low blue gradient.
        #values = c(0, 0.3, 1),
        # breaks = c(0, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9),
        # limits = c(0.01, 0.9),
        na.value = "white") +

   theme_cowplot() +
  theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 1, hjust = 1),
              axis.title.x = element_blank(),
              legend.position = "bottom") 

dotplot %>% ggplotly()

# No neurons in gw19_2 ???
ncx_full@meta.data %>% count(cell_type, individual) %>% dplyr::filter(individual == 'gw19_2')

load('../../../data/gw19_2.RData')
gw19_2_annot <- read_tsv('../../../data/gw19_2_clusteridentity_wholebrain_annotated.txt')
gw19_2_neurons <- gw19_2_annot %>% dplyr::filter(cell_type == 'Excitatory Neuron') 

ncx_full@meta.data %<>% set_rownames(.$cell_name)

ncx_full@meta.data %>% dplyr::filter(individual == 'gw19_2' & cell_type == 'neuron')
ncx_full@meta.data %>% dplyr::filter(cell_name %in% gw19_2_neurons$cell_name) %>% count(cell_type)

# FIX THIS
look in ncx_exn
sms('Done')


```
‣ 2020-12-04
# Cell types in ncx_full and ncx_exn gw19_2
```{r}
ncx_full@meta.data %>% dplyr::filter(cell_name %>% str_detect('gw19_2')) %>% count(cell_type)
#   cell_type    n
# 1        cr   63
# 2  dividing 2499
# 3       ipc 2763
# 4       opc  807
# 5        rg 2496

ncx_exn@meta.data %>% dplyr::filter(cell.name %>% str_detect('gw19_2')) %>% count(cell_type)
#   cell_type    n
# 1        cr   63
# 2  dividing 2499
# 3       ipc 2763
# 4       opc  807
# 5        rg 2496
```

```{r}
lapply(lst(tfs_MAST, tfs_wilcox), function(x) distinct(x, gene, cell_type, stage, area))

# 277 TF genes

tf_go <- left_join(go_ids, tfs_and_cofactors$tf_go_df[[1]]) %>% arrange(hgnc_symbol)

markers_all %<>% left_join(tfs)

markers_all %<>% mutate(is_tf = case_when(! is.na(family) ~ 'TF',
                                             TRUE ~ 'non_TF'))

markers_all %>% filter(! is.na(family))

# Somehow I had gotten all the genes that were TFs across all the groups? ??
markers_MAST %>% dplyr::filter(p_val_adj <= 0.1 & is_tf == 'TF') %>% count(cell_type, area, region)

tfs_MAST %>% count(cell_type, area, region)
```


```{r}
ncx_full@meta.data %<>% set_rownames(value = .$cell_name)
Idents(ncx_full) <- 'cell_type'
# TODO save this onject

ncx_full@active.ident

ncx_full@meta.data %>% filter(individual == 'gw16') %>% count(cell_type, area)
ncx_full@meta.data$area

THIS NEEDS TO BE SCALED BY EACH INDIVIDUAL.
```


# Plots: Trying to understand scaling vs not. 
Dot plots showing each individual of a stage.
```{r}
dotplot2 <- makeDotPlot(seurat_object = seurat_object, 
                        cell_type = 'rg', area = 'pfc', scale = TRUE,
                       genes_list = list(gene_list$early[-1]))

dotplot2[[1]]$data
```
```{r}
dotplot2 <- makeDotPlot(seurat_object = seurat_object, 
                        cell_type = 'rg', area = 'pfc', scale = FALSE,
                       genes_list = list(gene_list$early[-1]))
```
Not scaled, each gene separately. (own size scale)
```{r}
dotplot2 <- makeDotPlot(seurat_object = seurat_object, 
                        cell_type = 'rg', area = 'pfc', scale = TRUE,
                       genes_list = gene_list$early[-1])
```
```{r}
dotplot2 <- makeDotPlot(seurat_object = seurat_object, 
                        cell_type = 'rg', area = 'pfc', scale = FALSE,
                       genes_list = gene_list$early[-1])
```





# Actually make plots.
Combine individuals into stages like before.
Only show stage relevant to the marker gene.
Combine wilcox and MAST genes?
```{r}
tfs_by_group_MAST_wilcox$genes




```

