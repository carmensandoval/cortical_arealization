---
title: "FindMarkers v2"
date: 2020-11-23
output: 
  bookdown::html_document2:
    fig_caption: yes
  bookdown::pdf_document2:
    fig_caption: yes
---

```{r}
p_load(Seurat)
p_load(tidyverse)
p_load(bookdown)

remotes::install_github("rstudio/bookdown")
```

```{r}
repo_dir <- '~/cse-phd/second-trimester/'
project_dir <- file.path(repo_dir, 'neocortex/markers_area_celltype/')
data.dir <- file.path(repo_dir, '/neocortex/ncx_data/')

ncx_full <- read_rds(file.path(data.dir, 'exn_lineage/neocortex_exn_seuratobj.rds'))
ncx_split <- read_rds(file.path(data.dir, 'neocortex_split.rds'))
```

```{r}
source(file = file.path(project_dir, 'gene_function/transcription_factors/R/makeDotPlots.R'))
source('~/cse-phd/second-trimester/neocortex/R/expandMetadata.R')

source_rmd(file.path(repo_dir, '/R/geneScore.Rmd'))
source_rmd(file.path(project_dir, 'gene_function/transcription_factors/R/getGO_and_TF_annotations.Rmd'))
```

Currently `idents` are cell types

```{r}
ncx_full %>% Idents()
```

```{r}
ncx_full_df <- ncx_full@meta.data %>% dplyr::count(individual, cell_type, area) %>% 
  filter(cell_type %in% c('rg', 'ipc', 'neuron')) %>% as_tibble

# ncx_full_df$cells <- ncx_full_df %>% pmap(~ WhichCells(object = ncx_full, 
#                                                       expression = (individual == ..1 & 
#                                                                    cell_type == ..2 &
#                                                                    area == ..3))
#                                       )

all <- ncx_full_df %>% group_by(individual, cell_type) %>% 
        summarise(all = paste(cells, sep = ''))
          pmap(~ setdiff(..5, ))
```

```{r}
Idents(ncx_split$gw14) <- ncx_split$gw14@meta.data$area
ncx_split$gw14@meta.data$area %<>% as.character()
Idents(ncx_split$gw14) <- ncx_split$gw14@meta.data$cell_type %>% as.character

ncx_split$gw14@active.ident
ncx_split$gw14@meta.data %>% glimpse
```

# Get markers by cell type.

```{r}
markers_all <- ncx_split %>%
  imap(~ FindAllMarkersByCellType(seurat_object = .x, individual = .y))

# Stuff I had to do to get the cell type and individual associated with each gene (row) and consolidate.
# This should all be done within the FindAllMarkersByCellType function.

  # Set cell type list names.
  markers_all %<>% pmap(.f = ~ set_names(..2, value = ..3))
  
  # Add cell_type column to each marker table.
  markers_all$markers %<>% map(.f = ~ .x %>% imap(~ .x %>% mutate(cell_type = .y)) %>%
                                              reduce(bind_rows))
  
  # Add individual column and merge individual tables.
  markers_all %<>% pmap(~ ..2 %>% mutate(individual = ..1)) %>%
                          reduce(bind_rows)
  
  # Get gene scores and clean up markers table.
  markers_all %<>% getGeneScore

write_tsv(markers_all, "../out/area_markers_by_individual_and_celltype_MAST.txt")
write_rds(markers_all, "../out/area_markers_by_individual_and_celltype_MAST.rds")
```

# Markers per individual / area / cell type
```{r}
markers_all %>% ggplot() + geom_bar(aes(x = individual, fill = individual)) + 
  facet_grid(rows =  vars(cluster), cols = vars(cell_type))
```

# Get p_value_adj / log_FC distribution

```{r}
p_load(plotly)

p <- markers_all %>% 
      ggplot(aes(label.1 = gene, label.2 = diff.pct, label.4 = p_val_adj, label.3 = gene.score)) + 
        geom_jitter(aes(x = avg_logFC, y = -log10(p_val_adj + 0.00001), colour = individual),  
                    alpha = 0.6,
                    height = 0.1, width = 0.1) +
  facet_grid(vars(cluster), vars(cell_type)) +
  scale_colour_viridis_d(option = 'B')

  ggplotly(p) %>% 
    htmlwidgets::saveWidget(file.path(project_dir, 
                                      'area_markers_by_individual_and_celltype_MAST_volcanoPlot.html')
  
  
# TODO   Color this plot by [[transcription factor]] (yes TF /no TF)
```

# Figure out which are TFs

`From: getG0_and_TF_annotations.Rmd`

```{r}
goids_x <- getGO(genes = markers_all$gene )

tfs_and_cofactors <- getGenesWithTFannotation(go_df = goids_x )

tf_markers <- tfs_and_cofactors$tf_go_df[[1]] %>% distinct(hgnc_symbol, .keep_all = TRUE)

markers_all %<>% left_join(goids_x, by = c('gene' = 'hgnc_symbol')) %>% 
  left_join(tf_markers %>% dplyr::select(hgnc_symbol, family), by = c('gene' = 'hgnc_symbol'))
```

Which marker genes are TFs? 
Then keep only one entry for each gene in each `individual`, `cell_type`, `area` group. 
(markers_all must be grouped by those 3 variables) 
(There were more because there are many GO terms for each gene.)

```{r}
markers_tf <- markers_all %>% filter(! is.na(family)) %>% distinct(gene, .keep_all = TRUE)
```

Are there more TFs in radial glia? Count each gene only once per cell type (across all areas, ages)

```{r}
counts_ct <- markers_tf %>% ungroup %>% group_by(cell_type) %>% distinct(gene, .keep_all = TRUE) %>%

count(name = 'n_genes', cell_type)

ggplot(counts_ct) + geom_bar(aes(x = cell_type, fill = cell_type))
```

What proportion of marker genes for each cell type are TFs?

Get number of markers per cell type.

```{r}
counts_ct_tf <- markers_all %>% ungroup %>% group_by(cell_type) %>% 
  distinct(gene, .keep_all = TRUE) %>% count(cell_type, name = 'n_markers')

counts_ct %>% left_join(counts_ct_tf) %>% mutate(pct_tf = n_markers / n_genes)
```

```{r}
markers_all %<>% mutate(is_tf = case_when(! is.na(family) ~ 'TF',
                                                TRUE ~ 'non_TF'))

# Grouped by cell type, individual, area. Keep only one occurrence in each of these groups. 
# (Get rid of duplicate GO entries.)
markers_all %<>% distinct(gene, .keep_all = TRUE)
```

# Consolidate into stages and regions.

[x] `expandMetadata()`

```{r}
markers_all %<>% ungroup %>% rename(area = 'cluster') %>% 
  expandMetadata %>% arrange(stage, cell_type, area)
```

```{r}
p_load(viridis)
p_load(hrbrthemes)
p_load(patchwork)

df <- markers_all %>% ungroup %>% group_by(cell_type, stage) %>% distinct(gene, .keep_all = TRUE) 

barplot_tf <- df %>%
  ggplot(aes(x = cell_type, fill = is_tf)) +
  facet_wrap(~ stage, scales = 'free', nrow = 1) +
  scale_fill_viridis(discrete = T, end = 0.5) +
    # ggtitle("Proportion of TFs across cell types / time points") +
    theme_minimal() +
    xlab("") + ylab("")
  
p1 <- barplot_tf + geom_bar()

p2 <- barplot_tf + geom_bar(position = 'fill')

p1 + p2 + patchwork::plot_layout(ncol = 1, guides = 'collect') + 
  plot_annotation(title = 'Proportion of TFs across cell types / time points' )
```

# DotPlots: TF expression

across areas and stages

```{r}
markers_plot <- markers_all %>% dplyr::filter(is_tf == 'TF') %>% 
                  filter(cell_type == 'rg', area == 'pfc') %>% split(.$stage) %>%
                    map(~.x %>% pull(gene) %>% unique %>% sort)

dotplots <- data.frame(cell_type = '', area = '', dotplot = '')

seurat_object <- ncx_full %>% subset(subset = (cell_type == 'rg' & individual == 'gw16'))

dotplot <- makeDotPlot(seurat_object = ncx_full, cell_type = 'rg', area = 'pfc', 
                       genes_list = markers_plot)

dotplot$early
ncx_full@meta.data %<>% set_rownames(value = .$cell_name)
Idents(ncx_full) <- 'cell_type'
# TODO save this onject

ncx_full@active.ident

ncx_full@meta.data %>% filter(individual == 'gw16') %>% count(cell_type, area)
```

ncx_split %\<\>% enframe(name = 'individual', value = 'seurat_object')

ncx_split\$markers \<- markers_all ncx_split %\>% head(3)

markers_all %\>% imap( function() purrr::map(.x, \~ mutate(.x, individual = .y)) )

markers_all %\>% map(getGeneScore)

markers_all %\<\>% enframe(name = 'individual', value = 'markers')

markers_all\$cell_types \<- test %\>% enframe %\>% pull(value)

p_load(magrittr)

```{r}
FindAllMarkersByCellType <- function(seurat_object, individual) {
                                     # single individual
  
    object_split_by_celltype <- SplitObject(seurat_object, split.by = 'cell_type') %>% 
                          enframe(name = 'cell_type',
                                  value = 'seurat_object') %>%
                            filter(cell_type %in% c('rg', 'neuron', 'ipc'))
      
        # markers_by_celltype <- object_split_by_celltype %>% 
          
              # pmap(.f = function(cell_type, seurat_object) {
      
                    # Idents(seurat_object) <- seurat_object@meta.data$area
                     
                    # markers <- FindAllMarkers(max.cells.per.ident = 2000,
                                       #       slot = 'data',
                                       #       object = seurat_object,
                                       #              # subset(ncx_split$gw14, cell_type == 'rg'),
                                       #              # subset(ncx_full, individual == 'gw14'),
                                       #    # group.by = 'area',
                                       #    # ident.1 = 'pfc',
                                       #    test.use = 'MAST', 
                                       #    only.pos = TRUE,
                                       #    # logfc.threshold = 0.5,
                                       #    # pct.min = 0.3,
                                       #    # min.diff.pct = 0.2,
                                       #    verbose = TRUE)
                    
                   # markers$cell_type <- cell_type
                   #  markers$individual <- individual
                  #  })

    sms(individual)
   return(object_split_by_celltype$cell_type)
}
```

gw16 \<- ncx_full %\>% subset(subset = (cell_type == 'neuron' & individual == 'gw16')) rg \<- [ncx_full\@meta.data](mailto:ncx_full@meta.data){.email} %\>% filter(cell_type == 'rg' & individual == 'gw16')

all\$all %\>% length

rg \<- rg %\>% split(rg$individual) %>% imap(.f = ~ split(.x, .x$area)) %\>% enframe

rg\$value[1]

WhichCells(ncx_full, expression = cell_type == 'rg')
